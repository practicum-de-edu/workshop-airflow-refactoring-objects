# workshop-airflow-refactoring-objects
Workshop to show how objects work for Airflow.

## Шаг 1. Отделяем вызов от реализации.

Проблема: в DAG-файле смешаны вызовы функций и их реализация. Наша логика не может существовать отдельно от Airflow. Нет возможности тестировать логику без запуска DAG.

Решение: вынести реализацию в отдельный модуль.

Для этого:
1. Создаем папку `dwh` в корне проекта.
2. Создаем в ней папку dags - здесь будут DAG'и.
3. Создаем каталог `core/domain` - здесь будет основная бизнес-логика.
4. Переносим логику в `core`. В `dags` остаются только вызовы функций.
5. Добавляем mount `dwh` в `docker-compose.yml`.
6. Добавляем тесты для `core`.


## Шаг 2. Выделяем конфигурацию.
Проблема: конфигурация хранится внутри кода. Нет возможности переиспользовать конфигурацию в других DAG'ах. А если решим поменять конфигурацию, придется менять код (везде).

Решение: вынести конфигурацию в отдельный файл. 

Для этого:
1. Создаем файл `config.py` в каталогу `airflow/dags`.
2. Переносим чтение переменных, коннектов, настроек в `config.py`.
3. Импортируем конфигурацию в DAG-файл.


## Шаг 3. Репозиторий.

Проблема: код завязан на конкретную СУБД. Нет возможности сменить базу без изменения кода. 
И нет возможности прогнать тесты без СУБД. А с СУБД гонять тесты на любых стендах намного сложнее (надо следить за состоянием БД, нельзя прогонять тесты параллельно, либо надо готовить новую базу под каждый тест).

Решение: вынести работу с базой в отдельный модуль.

Для этого:
1. Создаем каталог `repository` в `core`.
2. Переносим работу с базой в `repository`.
3. Добавляем `repository` в `config.py`.
4. Обновляем DSG для работы с репозиторием.
5. Обновляем тесты для использования in-memory репозитория.



